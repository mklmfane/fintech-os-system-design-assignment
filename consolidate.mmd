flowchart TB
  %% Hub VNet
  subgraph HubVNet["Hub Virtual Network"]
    Firewall["Azure Firewall Subnet\n(Outbound)"]
    Bastion["Azure Bastion Subnet\n(Management)"]
    Jumpbox["Jumpbox Subnet\n(Host)"]
  end

  %% Spoke VNet
  subgraph SpokeVNet["🛰️ Spoke Virtual Network"]
    subgraph PrivateEndpoints["Private Link Endpoints Subnet"]
      ACR["Azure Container Registry"]
      DNS1["Private DNS Zone\nprivatelink.azurecr.io"]
      DNS2["Private DNS Zone\nprivatelink.region.azmk8s.io"]
    end

    subgraph Ingress["Ingress Resources Subnet"]
      ILB["Internal Load Balancer"]
      WAF["Azure Front Door or\nApp Gateway + WAF (L7)"]
      DDoS["Azure DDoS Protection (L3/L4)"]
    end

    subgraph CI_CD["CI/CD Tooling Subnet"]
      Pipelines["Azure Pipelines"]
      Helm["Helm Upgrade"]
      ACRPush["Docker Push"]
      ACRPull["Docker Pull"]
      Chaos["Azure Chaos Studio"]
    end

    subgraph AppGW["Azure Application Gateway Subnet"]
      AppGateway["App Gateway\n(WAF Enabled)"]
    end

    subgraph Identity["Identity Subnet"]
      AAD["Azure Active Directory"]
    end

    subgraph AKS["Cluster Nodes Subnet"]
      %% OSM Mesh Layer
      subgraph OSM_Mesh["Azure Open Service Mesh (OSM)"]
        direction TB

        subgraph AKSCluster["Azure Kubernetes Service\n(AKS) Cluster"]
          direction TB
          IngressCtrl["Ingress Controller (NGINX)"] --> FE["Front-end Services"]
          FE --> BackendBlock

          subgraph BackendBlock["Back-end Services"]
            WS["Web Server"]
            DB1["SQL Database"]
            DB2["Cosmos DB"]
            WS --> DB1
            WS --> DB2
          end

          subgraph Utility["Observability Services"]
            PM["Prometheus"]
            ES["Elasticsearch"]
            KB["Kibana"]
            Jaegar["Jaeger"]
            OTEL["OpenTelemetry"]
            Monitor["Azure Monitor"]
            Vault["Azure Key Vault"]
          end

          FE --> Utility
          Utility --> Monitor
          Utility --> Vault

          SystemNP["System Node Pool"]
          UserNP["User Node Pool\n(Workload)"]
        end
      end
    end
  end

  %% Internet (moved outside Spoke VNet)
  ClientApps["Client-Apps"]
  Internet["🌐 Internet"]

  %% Connectivity
  ClientApps --> Internet --> DDoS --> WAF --> AppGateway --> ILB --> IngressCtrl
  ACR -->|Private Link| AKSCluster
  DNS1 --> ACR
  DNS2 --> AKSCluster
  Bastion --> Jumpbox --> AKSCluster
  Firewall -->|Egress Control| AKSCluster

  %% DevOps and Identity
  Dev["👨‍💻 DevOps Engineer"] --> Bastion
  Bastion --> AAD
  AAD -->|RBAC| OSM_Mesh
  AAD --> Pipelines
  Pipelines --> Helm --> AKSCluster
  Pipelines --> ACRPush --> ACR --> ACRPull --> OSM_Mesh
  Pipelines --> Chaos --> OSM_Mesh

  %% VNet Peering
  HubVNet -->|VNet Peering| SpokeVNet

  %% Styling
  classDef service fill:#1f2937,stroke:#0078d4,color:#ffffff,stroke-width:1.5px;
  classDef node fill:#111827,color:#ffffff,stroke:#3b82f6;
  class HubVNet,SpokeVNet,PrivateEndpoints,Ingress,AKS,CI_CD,AppGW,Identity,Utility,BackendBlock,OSM_Mesh,AKSCluster service;
  class ACR,DNS1,DNS2,Dev,Bastion,Jumpbox,AAD,Internet,ClientApps,DDoS,WAF,AppGateway,ILB,IngressCtrl,FE,WS,DB1,DB2,PM,ES,KB,Jaegar,OTEL,Monitor,Vault,Pipelines,Helm,ACRPush,ACRPull,Chaos,SystemNP,UserNP node;
